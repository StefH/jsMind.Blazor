(function(n){"use strict";var f="jsMind",s="0.4.6",h="hizzgdev@163.com",e=function(){},i=typeof console=="undefined"?{log:e,debug:e,error:e,warn:e,info:e}:console,l,t;if((typeof module=="undefined"||!module.exports)&&typeof n[f]!="undefined"){i.log(f+" has been already exist.");return}var r=n.document,a=function(n){return r.getElementById(n)},u=function(n){return r.createElement(n)},o=function(n,t){n.hasChildNodes()?n.firstChild.nodeValue=t:n.appendChild(r.createTextNode(t))},c=function(n,t){t instanceof HTMLElement?(n.innerHTML="",n.appendChild(t)):n.innerHTML=t},v=function(n){return!!n&&typeof n=="object"&&n.nodeType===1&&typeof n.style=="object"&&typeof n.ownerDocument=="object"};typeof String.prototype.startsWith!="function"&&(String.prototype.startsWith=function(n){return this.slice(0,n.length)===n});l={container:"",editable:!1,theme:null,mode:"full",support_html:!0,view:{engine:"canvas",hmargin:100,vmargin:50,line_width:2,line_color:"#555"},layout:{hspace:30,vspace:20,pspace:13},default_event_handle:{enable_mousedown_handle:!0,enable_click_handle:!0,enable_dblclick_handle:!0},shortcut:{enable:!0,handles:{},mapping:{addchild:45,addbrother:13,editnode:113,delnode:46,toggle:32,left:37,up:38,right:39,down:40}}};t=function(n){t.current=this;this.version=s;var r={};if(t.util.json.merge(r,l),t.util.json.merge(r,n),!r.container){i.error("the options.container should not be null or empty.");return}this.options=r;this.inited=!1;this.mind=null;this.event_handles=[];this.init()};t.direction={left:-1,center:0,right:1};t.event_type={show:1,resize:2,edit:3,select:4};t.key={meta:8192,ctrl:4096,alt:2048,shift:1024};t.node=function(n,t,r,u,f,e,o,s){if(!n){i.error("invalid nodeid");return}if(typeof t!="number"){i.error("invalid node index");return}typeof s=="undefined"&&(s=!0);this.id=n;this.index=t;this.topic=r;this.data=u||{};this.isroot=f;this.parent=e;this.direction=o;this.expanded=!!s;this.children=[];this._data={}};t.node.compare=function(n,t){var i=n.index,r=t.index;return i>=0&&r>=0?i-r:i==-1&&r==-1?0:i==-1?1:r==-1?-1:0};t.node.inherited=function(n,t){if(!!n&&!!t){if(n.id===t.id||n.isroot)return!0;for(var r=n.id,i=t;!i.isroot;)if(i=i.parent,i.id===r)return!0}return!1};t.node.prototype={get_location:function(){var n=this._data.view;return{x:n.abs_x,y:n.abs_y}},get_size:function(){var n=this._data.view;return{w:n.width,h:n.height}}};t.mind=function(){this.name=null;this.author=null;this.version=null;this.root=null;this.selected=null;this.nodes={}};t.mind.prototype={get_node:function(n){return n in this.nodes?this.nodes[n]:(i.warn("the node[id="+n+"] can not be found"),null)},set_root:function(n,r,u){this.root==null?(this.root=new t.node(n,0,r,u,!0),this._put_node(this.root)):i.error("root node is already exist")},add_node:function(n,r,u,f,e,o,s){var a,v,h,c,l;if(!t.util.is_node(n))return a=this.get_node(n),a?this.add_node(a,r,u,f,e,o,s):(i.error("the parent_node[id="+n+"] can not be found."),null);if(v=e||-1,h=null,n.isroot){if(c=t.direction.right,isNaN(o)){var p=n.children,w=p.length,y=0;for(l=0;l<w;l++)p[l].direction===t.direction.left?y--:y++;c=w>1&&y>0?t.direction.left:t.direction.right}else c=o!=t.direction.left?t.direction.right:t.direction.left;h=new t.node(r,v,u,f,!1,n,c,s)}else h=new t.node(r,v,u,f,!1,n,n.direction,s);return this._put_node(h)?(n.children.push(h),this._reindex(n)):(i.error("fail, the nodeid '"+h.id+"' has been already exist."),h=null),h},insert_node_before:function(n,r,u,f){var e,o;return t.util.is_node(n)?(o=n.index-.5,this.add_node(n.parent,r,u,f,o)):(e=this.get_node(n),e?this.insert_node_before(e,r,u,f):(i.error("the node_before[id="+n+"] can not be found."),null))},get_node_before:function(n){var r,u;return t.util.is_node(n)?n.isroot?null:(u=n.index-2,u>=0?n.parent.children[u]:null):(r=this.get_node(n),r?this.get_node_before(r):(i.error("the node[id="+n+"] can not be found."),null))},insert_node_after:function(n,r,u,f){var e,o;return t.util.is_node(n)?(o=n.index+.5,this.add_node(n.parent,r,u,f,o)):(e=this.get_node(n),e?this.insert_node_after(e,r,u,f):(i.error("the node_after[id="+n+"] can not be found."),null))},get_node_after:function(n){var r,u,f;return t.util.is_node(n)?n.isroot?null:(u=n.index,f=n.parent.children,f.length>=u?n.parent.children[u]:null):(r=this.get_node(n),r?this.get_node_after(r):(i.error("the node[id="+n+"] can not be found."),null))},move_node:function(n,r,u,f){if(!t.util.is_node(n)){var e=this.get_node(n);return e?this.move_node(e,r,u,f):(i.error("the node[id="+n+"] can not be found."),null)}return u||(u=n.parent.id),this._move_node(n,r,u,f)},_flow_node_direction:function(n,t){typeof t=="undefined"?t=n.direction:n.direction=t;for(var i=n.children.length;i--;)this._flow_node_direction(n.children[i],t)},_move_node_internal:function(n,t){if(!!n&&!!t)if(t=="_last_")n.index=-1,this._reindex(n.parent);else if(t=="_first_")n.index=0,this._reindex(n.parent);else{var i=!t?null:this.get_node(t);i!=null&&i.parent!=null&&i.parent.id==n.parent.id&&(n.index=i.index-.5,this._reindex(n.parent))}return n},_move_node:function(n,i,r,u){if(!!n&&!!r){if(n.parent.id!=r){for(var f=n.parent.children,e=f.length;e--;)if(f[e].id==n.id){f.splice(e,1);break}n.parent=this.get_node(r);n.parent.children.push(n)}n.direction=n.parent.isroot?u==t.direction.left?u:t.direction.right:n.parent.direction;this._move_node_internal(n,i);this._flow_node_direction(n)}return n},remove_node:function(n){var e,r,o,u,f,s;if(!t.util.is_node(n))return e=this.get_node(n),e?this.remove_node(e):(i.error("the node[id="+n+"] can not be found."),!1);if(!n)return i.error("fail, the node can not be found"),!1;if(n.isroot)return i.error("fail, can not remove root node"),!1;for(this.selected!=null&&this.selected.id==n.id&&(this.selected=null),r=n.children,o=r.length;o--;)this.remove_node(r[o]);for(r.length=0,u=n.parent.children,f=u.length;f--;)if(u[f].id==n.id){u.splice(f,1);break}delete this.nodes[n.id];for(s in n)delete n[s];return n=null,!0},_put_node:function(n){return n.id in this.nodes?(i.warn("the nodeid '"+n.id+"' has been already exist."),!1):(this.nodes[n.id]=n,!0)},_reindex:function(n){if(n instanceof t.node){n.children.sort(t.node.compare);for(var i=0;i<n.children.length;i++)n.children[i].index=i+1}}};t.format={node_tree:{example:{meta:{name:f,author:h,version:s},format:"node_tree",data:{id:"root",topic:"jsMind Example"}},get_mind:function(n){var r=t.format.node_tree,i=new t.mind;return i.name=n.meta.name,i.author=n.meta.author,i.version=n.meta.version,r._parse(i,n.data),i},get_data:function(n){var r=t.format.node_tree,i={};return i.meta={name:n.name,author:n.author,version:n.version},i.format="node_tree",i.data=r._buildnode(n.root),i},_parse:function(n,i){var f=t.format.node_tree,e=f._extract_data(i),u,r;if(n.set_root(i.id,i.topic,e),"children"in i)for(u=i.children,r=0;r<u.length;r++)f._extract_subnode(n,n.root,u[r])},_extract_data:function(n){var i={};for(var t in n)t!="id"&&t!="topic"&&t!="children"&&t!="direction"&&t!="expanded"&&(i[t]=n[t]);return i},_extract_subnode:function(n,i,r){var e=t.format.node_tree,h=e._extract_data(r),o=null,s,f,u;if(i.isroot&&(o=r.direction=="left"?t.direction.left:t.direction.right),s=n.add_node(i,r.id,r.topic,h,null,o,r.expanded),!!r.children)for(f=r.children,u=0;u<f.length;u++)e._extract_subnode(n,s,f[u])},_buildnode:function(n){var o=t.format.node_tree,i,f,e,r,u;if(n instanceof t.node){if(i={id:n.id,topic:n.topic,expanded:n.expanded},!!n.parent&&n.parent.isroot&&(i.direction=n.direction==t.direction.left?"left":"right"),n.data!=null){f=n.data;for(e in f)i[e]=f[e]}if(r=n.children,r.length>0)for(i.children=[],u=0;u<r.length;u++)i.children.push(o._buildnode(r[u]));return i}}},node_array:{example:{meta:{name:f,author:h,version:s},format:"node_array",data:[{id:"root",topic:"jsMind Example",isroot:!0}]},get_mind:function(n){var r=t.format.node_array,i=new t.mind;return i.name=n.meta.name,i.author=n.meta.author,i.version=n.meta.version,r._parse(i,n.data),i},get_data:function(n){var r=t.format.node_array,i={};return i.meta={name:n.name,author:n.author,version:n.version},i.format="node_array",i.data=[],r._array(n,i.data),i},_parse:function(n,r){var e=t.format.node_array,u=r.slice(0),f;u.reverse();f=e._extract_root(n,u);f?e._extract_subnode(n,f,u):i.error("root node can not be found")},_extract_root:function(n,i){for(var e=t.format.node_array,r=i.length,u,f;r--;)if("isroot"in i[r]&&i[r].isroot)return u=i[r],f=e._extract_data(u),n.set_root(u.id,u.topic,f),i.splice(r,1),u.id;return null},_extract_subnode:function(n,i,r){for(var c=t.format.node_array,f=r.length,u=null,l=null,e=0,o,s,h;f--;)u=r[f],u.parentid==i&&(l=c._extract_data(u),o=null,s=u.direction,!s||(o=s=="left"?t.direction.left:t.direction.right),n.add_node(i,u.id,u.topic,l,null,o,u.expanded),r.splice(f,1),e++,h=c._extract_subnode(n,u.id,r),h>0&&(f=r.length,e+=h));return e},_extract_data:function(n){var i={};for(var t in n)t!="id"&&t!="topic"&&t!="parentid"&&t!="isroot"&&t!="direction"&&t!="expanded"&&(i[t]=n[t]);return i},_array:function(n,i){var r=t.format.node_array;r._array_node(n.root,i)},_array_node:function(n,i){var s=t.format.node_array,r,f,e,o,u;if(n instanceof t.node){if(r={id:n.id,topic:n.topic,expanded:n.expanded},!n.parent||(r.parentid=n.parent.id),n.isroot&&(r.isroot=!0),!!n.parent&&n.parent.isroot&&(r.direction=n.direction==t.direction.left?"left":"right"),n.data!=null){f=n.data;for(e in f)r[e]=f[e]}for(i.push(r),o=n.children.length,u=0;u<o;u++)s._array_node(n.children[u],i)}}},freemind:{example:{meta:{name:f,author:h,version:s},format:"freemind",data:'<map version="1.0.1"><node ID="root" TEXT="freemind Example"/><\/map>'},get_mind:function(n){var r=t.format.freemind,i=new t.mind;i.name=n.meta.name;i.author=n.meta.author;i.version=n.meta.version;var u=n.data,f=r._parse_xml(u),e=r._find_root(f);return r._load_node(i,null,e),i},get_data:function(n){var u=t.format.freemind,r={},i;return r.meta={name:n.name,author:n.author,version:n.version},r.format="freemind",i=[],i.push('<map version="1.0.1">'),u._buildmap(n.root,i),i.push("<\/map>"),r.data=i.join(" "),r},_parse_xml:function(n){var t=null,i;return window.DOMParser?(i=new DOMParser,t=i.parseFromString(n,"text/xml")):(t=new ActiveXObject("Microsoft.XMLDOM"),t.async=!1,t.loadXML(n)),t},_find_root:function(n){for(var u,f=n.childNodes,r=null,t=null,i=0;i<f.length;i++)if(t=f[i],t.nodeType==1&&t.tagName=="map"){r=t;break}if(!!r)for(u=r.childNodes,r=null,i=0;i<u.length;i++)if(t=u[i],t.nodeType==1&&t.tagName=="node"){r=t;break}return r},_load_node:function(n,i,r){var y=t.format.freemind,h=r.getAttribute("ID"),s=r.getAttribute("TEXT"),c,e,f,p,l,a,v,o,u;if(s==null)for(c=r.childNodes,e=null,u=0;u<c.length;u++)if(e=c[u],e.nodeType==1&&e.tagName==="richcontent"){s=e.textContent;break}for(f=y._load_attributes(r),p=("expanded"in f)?f.expanded=="true":!0,delete f.expanded,l=r.getAttribute("POSITION"),a=null,!l||(a=l=="left"?t.direction.left:t.direction.right),i?n.add_node(i,h,s,f,null,a,p):n.set_root(h,s,f),v=r.childNodes,o=null,u=0;u<v.length;u++)o=v[u],o.nodeType==1&&o.tagName=="node"&&y._load_node(n,h,o)},_load_attributes:function(n){for(var r=n.childNodes,t=null,u={},i=0;i<r.length;i++)t=r[i],t.nodeType==1&&t.tagName==="attribute"&&(u[t.getAttribute("NAME")]=t.getAttribute("VALUE"));return u},_buildmap:function(n,i){var s=t.format.freemind,f=null,r,e,o,u;if(!!n.parent&&n.parent.isroot&&(f=n.direction===t.direction.left?"left":"right"),i.push("<node"),i.push('ID="'+n.id+'"'),!f||i.push('POSITION="'+f+'"'),i.push('TEXT="'+n.topic+'">'),i.push('<attribute NAME="expanded" VALUE="'+n.expanded+'"/>'),r=n.data,r!=null)for(e in r)i.push('<attribute NAME="'+e+'" VALUE="'+r[e]+'"/>');for(o=n.children,u=0;u<o.length;u++)s._buildmap(o[u],i);i.push("<\/node>")}}};t.util={is_node:function(n){return!!n&&n instanceof t.node},ajax:{_xhr:function(){var n=null;if(window.XMLHttpRequest)n=new XMLHttpRequest;else try{n=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}return n},_eurl:function(n){return encodeURIComponent(n)},request:function(n,r,u,f,e){var s=t.util.ajax,l=null,h=[],c,o;for(c in r)h.push(s._eurl(c)+"="+s._eurl(r[c]));(h.length>0&&(l=h.join("&")),o=s._xhr(),o)&&(o.onreadystatechange=function(){if(o.readyState==4)if(o.status==200||o.status==0){if(typeof f=="function"){var n=t.util.json.string2json(o.responseText);n!=null?f(n):f(o.responseText)}}else typeof e=="function"?e(o):i.error("xhr request failed.",o)},u=u||"GET",o.open(u,n,!0),o.setRequestHeader("If-Modified-Since","0"),u=="POST"?(o.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),o.send(l)):o.send())},get:function(n,i){return t.util.ajax.request(n,{},"GET",i)},post:function(n,i,r){return t.util.ajax.request(n,i,"POST",r)}},dom:{add_event:function(n,t,i){n.addEventListener?n.addEventListener(t,i,!1):n.attachEvent("on"+t,i)}},file:{read:function(n,t){var i=new FileReader;i.onload=function(){typeof t=="function"&&t(this.result,n.name)};i.readAsText(n)},save:function(t,i,f){var o,c,s,h;if(typeof n.Blob=="function"?o=new Blob([t],{type:i}):(c=n.BlobBuilder||n.MozBlobBuilder||n.WebKitBlobBuilder||n.MSBlobBuilder,s=new c,s.append(t),o=s.getBlob(i)),navigator.msSaveBlob)navigator.msSaveBlob(o,f);else{var a=n.URL||n.webkitURL,l=a.createObjectURL(o),e=u("a");"download"in e?(e.style.visibility="hidden",e.href=l,e.download=f,r.body.appendChild(e),h=r.createEvent("MouseEvents"),h.initEvent("click",!0,!0),e.dispatchEvent(h),r.body.removeChild(e)):location.href=l}}},json:{json2string:function(n){if(!!JSON)try{return JSON.stringify(n)}catch(t){return i.warn(t),i.warn("can not convert to string"),null}},string2json:function(n){if(!!JSON)try{return JSON.parse(n)}catch(t){return i.warn(t),i.warn("can not parse to json"),null}},merge:function(n,i){for(var r in i)r in n?typeof n[r]!="object"||Object.prototype.toString.call(n[r]).toLowerCase()!="[object object]"||n[r].length?n[r]=i[r]:t.util.json.merge(n[r],i[r]):n[r]=i[r];return n}},uuid:{newid:function(){return((new Date).getTime().toString(16)+Math.random().toString(16).substr(2)).substr(2,16)}},text:{is_empty:function(n){return n?n.replace(/\s*/,"").length==0:!0}}};t.prototype={init:function(){if(!this.inited){this.inited=!0;var n=this.options,i={mode:n.mode,hspace:n.layout.hspace,vspace:n.layout.vspace,pspace:n.layout.pspace},r={container:n.container,support_html:n.support_html,engine:n.view.engine,hmargin:n.view.hmargin,vmargin:n.view.vmargin,line_width:n.view.line_width,line_color:n.view.line_color};this.data=new t.data_provider(this);this.layout=new t.layout_provider(this,i);this.view=new t.view_provider(this,r);this.shortcut=new t.shortcut_provider(this,n.shortcut);this.data.init();this.layout.init();this.view.init();this.shortcut.init();this._event_bind();t.init_plugins(this)}},enable_edit:function(){this.options.editable=!0},disable_edit:function(){this.options.editable=!1},enable_event_handle:function(n){this.options.default_event_handle["enable_"+n+"_handle"]=!0},disable_event_handle:function(n){this.options.default_event_handle["enable_"+n+"_handle"]=!1},get_editable:function(){return this.options.editable},set_theme:function(n){var t=this.options.theme;this.options.theme=!n?null:n;t!=this.options.theme&&(this.view.reset_theme(),this.view.reset_custom_style())},_event_bind:function(){this.view.add_event(this,"mousedown",this.mousedown_handle);this.view.add_event(this,"click",this.click_handle);this.view.add_event(this,"dblclick",this.dblclick_handle)},mousedown_handle:function(n){if(this.options.default_event_handle.enable_mousedown_handle){var t=n.target||event.srcElement,i=this.view.get_binded_nodeid(t);i?t.tagName.toLowerCase()=="jmnode"&&this.select_node(i):this.select_clear()}},click_handle:function(n){var t,r,i;this.options.default_event_handle.enable_click_handle&&(t=n.target||event.srcElement,r=this.view.is_expander(t),r&&(i=this.view.get_binded_nodeid(t),!i||this.toggle_node(i)))},dblclick_handle:function(n){if(this.options.default_event_handle.enable_dblclick_handle&&this.get_editable()){var i=n.target||event.srcElement,t=this.view.get_binded_nodeid(i);!t||this.begin_edit(t)}},begin_edit:function(n){if(!t.util.is_node(n)){var r=this.get_node(n);return r?this.begin_edit(r):(i.error("the node[id="+n+"] can not be found."),!1)}if(this.get_editable())this.view.edit_node_begin(n);else{i.error("fail, this mind map is not editable.");return}},end_edit:function(){this.view.edit_node_end()},toggle_node:function(n){if(!t.util.is_node(n)){var r=this.get_node(n);if(r)return this.toggle_node(r);i.error("the node[id="+n+"] can not be found.");return}n.isroot||(this.view.save_location(n),this.layout.toggle_node(n),this.view.relayout(),this.view.restore_location(n))},expand_node:function(n){if(!t.util.is_node(n)){var r=this.get_node(n);if(r)return this.expand_node(r);i.error("the node[id="+n+"] can not be found.");return}n.isroot||(this.view.save_location(n),this.layout.expand_node(n),this.view.relayout(),this.view.restore_location(n))},collapse_node:function(n){if(!t.util.is_node(n)){var r=this.get_node(n);if(r)return this.collapse_node(r);i.error("the node[id="+n+"] can not be found.");return}n.isroot||(this.view.save_location(n),this.layout.collapse_node(n),this.view.relayout(),this.view.restore_location(n))},expand_all:function(){this.layout.expand_all();this.view.relayout()},collapse_all:function(){this.layout.collapse_all();this.view.relayout()},expand_to_depth:function(n){this.layout.expand_to_depth(n);this.view.relayout()},_reset:function(){this.view.reset();this.layout.reset();this.data.reset()},_show:function(n){var r=n||t.format.node_array.example;if(this.mind=this.data.load(r),this.mind)i.debug("data.load ok");else{i.error("data.load error");return}this.view.load();i.debug("view.load ok");this.layout.layout();i.debug("layout.layout ok");this.view.show(!0);i.debug("view.show ok");this.invoke_event_handle(t.event_type.show,{data:[n]})},show:function(n){this._reset();this._show(n)},get_meta:function(){return{name:this.mind.name,author:this.mind.author,version:this.mind.version}},get_data:function(n){var t=n||"node_tree";return this.data.get_data(t)},get_root:function(){return this.mind.root},get_node:function(n){return this.mind.get_node(n)},add_node:function(n,r,u,f){if(this.get_editable()){var e=this.mind.add_node(n,r,u,f);return!e||(this.view.add_node(e),this.layout.layout(),this.view.show(!1),this.view.reset_node_custom_style(e),this.expand_node(n),this.invoke_event_handle(t.event_type.edit,{evt:"add_node",data:[n.id,r,u,f],node:r})),e}return i.error("fail, this mind map is not editable"),null},insert_node_before:function(n,r,u,f){if(this.get_editable()){var o=t.util.is_node(n)?n.id:n,e=this.mind.insert_node_before(n,r,u,f);return!e||(this.view.add_node(e),this.layout.layout(),this.view.show(!1),this.invoke_event_handle(t.event_type.edit,{evt:"insert_node_before",data:[o,r,u,f],node:r})),e}return i.error("fail, this mind map is not editable"),null},insert_node_after:function(n,r,u,f){if(this.get_editable()){var o=t.util.is_node(n)?n.id:n,e=this.mind.insert_node_after(n,r,u,f);return!e||(this.view.add_node(e),this.layout.layout(),this.view.show(!1),this.invoke_event_handle(t.event_type.edit,{evt:"insert_node_after",data:[o,r,u,f],node:r})),e}return i.error("fail, this mind map is not editable"),null},remove_node:function(n){var r;if(!t.util.is_node(n))return r=this.get_node(n),r?this.remove_node(r):(i.error("the node[id="+n+"] can not be found."),!1);if(this.get_editable()){if(n.isroot)return i.error("fail, can not remove root node"),!1;var e=n.id,u=n.parent.id,f=this.get_node(u);return this.view.save_location(f),this.view.remove_node(n),this.mind.remove_node(n),this.layout.layout(),this.view.show(!1),this.view.restore_location(f),this.invoke_event_handle(t.event_type.edit,{evt:"remove_node",data:[e],node:u}),!0}return i.error("fail, this mind map is not editable"),!1},update_node:function(n,r){if(this.get_editable()){if(t.util.text.is_empty(r)){i.warn("fail, topic can not be empty");return}var u=this.get_node(n);if(!!u){if(u.topic===r){i.info("nothing changed");this.view.update_node(u);return}u.topic=r;this.view.update_node(u);this.layout.layout();this.view.show(!1);this.invoke_event_handle(t.event_type.edit,{evt:"update_node",data:[n,r],node:n})}}else{i.error("fail, this mind map is not editable");return}},move_node:function(n,r,u,f){if(this.get_editable()){var e=this.mind.move_node(n,r,u,f);!e||(this.view.update_node(e),this.layout.layout(),this.view.show(!1),this.invoke_event_handle(t.event_type.edit,{evt:"move_node",data:[n,r,u,f],node:n}))}else{i.error("fail, this mind map is not editable");return}},select_node:function(n){if(!t.util.is_node(n)){var r=this.get_node(n);if(r)return this.select_node(r);i.error("the node[id="+n+"] can not be found.");return}this.layout.is_visible(n)&&(this.mind.selected=n,this.view.select_node(n),this.invoke_event_handle(t.event_type.select,{evt:"select_node",data:[],node:n.id}))},get_selected_node:function(){return this.mind?this.mind.selected:null},select_clear:function(){!this.mind||(this.mind.selected=null,this.view.select_clear())},is_node_visible:function(n){return this.layout.is_visible(n)},find_node_before:function(n){var e,r,f;if(!t.util.is_node(n)){if(e=this.get_node(n),e)return this.find_node_before(e);i.error("the node[id="+n+"] can not be found.");return}if(n.isroot)return null;if(r=null,n.parent.isroot){var o=n.parent.children,s=null,u=null;for(f=0;f<o.length;f++)u=o[f],n.direction===u.direction&&(n.id===u.id&&(r=s),s=u)}else r=this.mind.get_node_before(n);return r},find_node_after:function(n){var e,r,f;if(!t.util.is_node(n)){if(e=this.get_node(n),e)return this.find_node_after(e);i.error("the node[id="+n+"] can not be found.");return}if(n.isroot)return null;if(r=null,n.parent.isroot){var o=n.parent.children,s=!1,u=null;for(f=0;f<o.length;f++)if(u=o[f],n.direction===u.direction){if(s){r=u;break}n.id===u.id&&(s=!0)}}else r=this.mind.get_node_after(n);return r},set_node_color:function(n,t,r){if(this.get_editable()){var u=this.mind.get_node(n);!u||(!t||(u.data["background-color"]=t),!r||(u.data["foreground-color"]=r),this.view.reset_node_custom_style(u))}else return i.error("fail, this mind map is not editable"),null},set_node_font_style:function(n,t,r,u){if(this.get_editable()){var f=this.mind.get_node(n);!f||(!t||(f.data["font-size"]=t),!r||(f.data["font-weight"]=r),!u||(f.data["font-style"]=u),this.view.reset_node_custom_style(f),this.view.update_node(f),this.layout.layout(),this.view.show(!1))}else return i.error("fail, this mind map is not editable"),null},set_node_background_image:function(n,t,r,u,f){if(this.get_editable()){var e=this.mind.get_node(n);!e||(!t||(e.data["background-image"]=t),!r||(e.data.width=r),!u||(e.data.height=u),!f||(e.data["background-rotation"]=f),this.view.reset_node_custom_style(e),this.view.update_node(e),this.layout.layout(),this.view.show(!1))}else return i.error("fail, this mind map is not editable"),null},set_node_background_rotation:function(n,t){if(this.get_editable()){var r=this.mind.get_node(n);if(!!r){if(!r.data["background-image"])return i.error("fail, only can change rotation angle of node with background image"),null;r.data["background-rotation"]=t;this.view.reset_node_custom_style(r);this.view.update_node(r);this.layout.layout();this.view.show(!1)}}else return i.error("fail, this mind map is not editable"),null},resize:function(){this.view.resize()},add_event_listener:function(n){typeof n=="function"&&this.event_handles.push(n)},clear_event_listener:function(){this.event_handles=[]},invoke_event_handle:function(t,i){var r=this;n.setTimeout(function(){r._invoke_event_handle(t,i)},0)},_invoke_event_handle:function(n,t){for(var r=this.event_handles.length,i=0;i<r;i++)this.event_handles[i](n,t)}};t.data_provider=function(n){this.jm=n};t.data_provider.prototype={init:function(){i.debug("data.init")},reset:function(){i.debug("data.reset")},load:function(n){var r=null,u=null;return r=typeof n=="object"?n.format?n.format:"node_tree":"freemind",r=="node_array"?u=t.format.node_array.get_mind(n):r=="node_tree"?u=t.format.node_tree.get_mind(n):r=="freemind"?u=t.format.freemind.get_mind(n):i.warn("unsupported format"),u},get_data:function(n){var r=null;return n=="node_array"?r=t.format.node_array.get_data(this.jm.mind):n=="node_tree"?r=t.format.node_tree.get_data(this.jm.mind):n=="freemind"?r=t.format.freemind.get_data(this.jm.mind):i.error("unsupported "+n+" format"),r}};t.layout_provider=function(n,t){this.opts=t;this.jm=n;this.isside=this.opts.mode=="side";this.bounds=null;this.cache_valid=!1};t.layout_provider.prototype={init:function(){i.debug("layout.init")},reset:function(){i.debug("layout.reset");this.bounds={n:0,s:0,w:0,e:0}},layout:function(){i.debug("layout.layout");this.layout_direction();this.layout_offset()},layout_direction:function(){this._layout_direction_root()},_layout_direction_root:function(){var u=this.jm.mind.root,i=null,f,e,n,r;if("layout"in u._data?i=u._data.layout:(i={},u._data.layout=i),f=u.children,e=f.length,i.direction=t.direction.center,i.side_index=0,this.isside)for(n=e;n--;)this._layout_direction_side(f[n],t.direction.right,n);else for(n=e,r=null;n--;)r=f[n],r.direction==t.direction.left?this._layout_direction_side(r,t.direction.left,n):this._layout_direction_side(r,t.direction.right,n)},_layout_direction_side:function(n,t,i){var r=null,f,e,u;for(("layout"in n._data)?r=n._data.layout:(r={},n._data.layout=r),f=n.children,e=f.length,r.direction=t,r.side_index=i,u=e;u--;)this._layout_direction_side(f[u],t,u)},layout_offset:function(){var r=this.jm.mind.root,n=r._data.layout;n.offset_x=0;n.offset_y=0;n.outer_height=0;for(var e=r.children,o=e.length,u=[],f=[],i=null;o--;)i=e[o],i._data.layout.direction==t.direction.right?f.unshift(i):u.unshift(i);n.left_nodes=u;n.right_nodes=f;n.outer_height_left=this._layout_offset_subnodes(u);n.outer_height_right=this._layout_offset_subnodes(f);this.bounds.e=r._data.view.width/2;this.bounds.w=0-this.bounds.e;this.bounds.n=0;this.bounds.s=Math.max(n.outer_height_left,n.outer_height_right)},_layout_offset_subnodes:function(n){for(var f=0,e=n.length,u=e,t=null,i=0,r=null,s=0,o=null,h;u--;)t=n[u],r=t._data.layout,o==null&&(o=t.parent._data),i=this._layout_offset_subnodes(t.children),t.expanded||(i=0,this.set_visible(t.children,!1)),i=Math.max(t._data.view.height,i),r.outer_height=i,r.offset_y=s-i/2,r.offset_x=this.opts.hspace*r.direction+o.view.width*(o.layout.direction+r.direction)/2,t.parent.isroot||(r.offset_x+=this.opts.pspace*r.direction),s=s-i-this.opts.vspace,f+=i;for(e>1&&(f+=this.opts.vspace*(e-1)),u=e,h=f/2;u--;)t=n[u],t._data.layout.offset_y+=h;return f},_layout_offset_subnodes_height:function(n){for(var u=0,f=n.length,r=f,t=null,i=0,e=null,o=0,s=null,h;r--;)t=n[r],e=t._data.layout,s==null&&(s=t.parent._data),i=this._layout_offset_subnodes_height(t.children),t.expanded||(i=0),i=Math.max(t._data.view.height,i),e.outer_height=i,e.offset_y=o-i/2,o=o-i-this.opts.vspace,u+=i;for(f>1&&(u+=this.opts.vspace*(f-1)),r=f,h=u/2;r--;)t=n[r],t._data.layout.offset_y+=h;return u},get_node_offset:function(n){var i=n._data.layout,t=null,r,u,f;return"_offset_"in i&&this.cache_valid?t=i._offset_:(t={x:-1,y:-1},i._offset_=t),(t.x==-1||t.y==-1)&&(r=i.offset_x,u=i.offset_y,n.isroot||(f=this.get_node_offset(n.parent),r+=f.x,u+=f.y),t.x=r,t.y=u),t},get_node_point:function(n){var i=n._data.view,r=this.get_node_offset(n),t={};return t.x=r.x+i.width*(n._data.layout.direction-1)/2,t.y=r.y-i.height/2,t},get_node_point_in:function(n){return this.get_node_offset(n)},get_node_point_out:function(n){var i=n._data.layout,t=null,u,r;return"_pout_"in i&&this.cache_valid?t=i._pout_:(t={x:-1,y:-1},i._pout_=t),(t.x==-1||t.y==-1)&&(n.isroot?(t.x=0,t.y=0):(u=n._data.view,r=this.get_node_offset(n),t.x=r.x+(u.width+this.opts.pspace)*n._data.layout.direction,t.y=r.y)),t},get_expander_point:function(n){var i=this.get_node_point_out(n),r={};return r.x=n._data.layout.direction==t.direction.right?i.x-this.opts.pspace:i.x,r.y=i.y-Math.ceil(this.opts.pspace/2),r},get_min_size:function(){var t=this.jm.mind.nodes,i=null,n=null;for(var r in t)i=t[r],n=this.get_node_point_out(i),n.x>this.bounds.e&&(this.bounds.e=n.x),n.x<this.bounds.w&&(this.bounds.w=n.x);return{w:this.bounds.e-this.bounds.w,h:this.bounds.s-this.bounds.n}},toggle_node:function(n){n.isroot||(n.expanded?this.collapse_node(n):this.expand_node(n))},expand_node:function(n){n.expanded=!0;this.part_layout(n);this.set_visible(n.children,!0);this.jm.invoke_event_handle(t.event_type.show,{evt:"expand_node",data:[],node:n.id})},collapse_node:function(n){n.expanded=!1;this.part_layout(n);this.set_visible(n.children,!1);this.jm.invoke_event_handle(t.event_type.show,{evt:"collapse_node",data:[],node:n.id})},expand_all:function(){var i=this.jm.mind.nodes,r=0,n,u,t;for(u in i)n=i[u],n.expanded||(n.expanded=!0,r++);r>0&&(t=this.jm.mind.root,this.part_layout(t),this.set_visible(t.children,!0))},collapse_all:function(){var i=this.jm.mind.nodes,r=0,n,u,t;for(u in i)n=i[u],n.expanded&&!n.isroot&&(n.expanded=!1,r++);r>0&&(t=this.jm.mind.root,this.part_layout(t),this.set_visible(t.children,!0))},expand_to_depth:function(n,t,i){if(!(n<1))for(var f=t||this.jm.mind.root.children,u=i||1,e=f.length,r=null;e--;)r=f[e],u<n&&(r.expanded||this.expand_node(r),this.expand_to_depth(n,r.children,u+1)),u==n&&r.expanded&&this.collapse_node(r)},part_layout:function(n){var u=this.jm.mind.root,r;u?(r=u._data.layout,n.isroot?(r.outer_height_right=this._layout_offset_subnodes_height(r.right_nodes),r.outer_height_left=this._layout_offset_subnodes_height(r.left_nodes)):n._data.layout.direction==t.direction.right?r.outer_height_right=this._layout_offset_subnodes_height(r.right_nodes):r.outer_height_left=this._layout_offset_subnodes_height(r.left_nodes),this.bounds.s=Math.max(r.outer_height_left,r.outer_height_right),this.cache_valid=!1):i.warn("can not found root node")},set_visible:function(n,t){for(var r=n.length,i=null,u=null;r--;)i=n[r],u=i._data.layout,i.expanded?this.set_visible(i.children,t):this.set_visible(i.children,!1),i.isroot||(i._data.layout.visible=t)},is_expand:function(n){return n.expanded},is_visible:function(n){var t=n._data.layout;return"visible"in t&&!t.visible?!1:!0}};t.graph_canvas=function(n){this.opts=n.opts;this.e_canvas=u("canvas");this.e_canvas.className="jsmind";this.canvas_ctx=this.e_canvas.getContext("2d");this.size={w:0,h:0}};t.graph_canvas.prototype={element:function(){return this.e_canvas},set_size:function(n,t){this.size.w=n;this.size.h=t;this.e_canvas.width=n;this.e_canvas.height=t},clear:function(){this.canvas_ctx.clearRect(0,0,this.size.w,this.size.h)},draw_line:function(n,t,i){var r=this.canvas_ctx;r.strokeStyle=this.opts.line_color;r.lineWidth=this.opts.line_width;r.lineCap="round";this._bezier_to(r,t.x+i.x,t.y+i.y,n.x+i.x,n.y+i.y)},copy_to:function(n,t){n.drawImage(this.e_canvas,0,0);!t||t()},_bezier_to:function(n,t,i,r,u){n.beginPath();n.moveTo(t,i);n.bezierCurveTo(t+(r-t)*2/3,i,t,u,r,u);n.stroke()},_line_to:function(n,t,i,r,u){n.beginPath();n.moveTo(t,i);n.lineTo(r,u);n.stroke()}};t.graph_svg=function(n){this.view=n;this.opts=n.opts;this.e_svg=t.graph_svg.c("svg");this.e_svg.setAttribute("class","jsmind");this.size={w:0,h:0};this.lines=[]};t.graph_svg.c=function(n){return r.createElementNS("http://www.w3.org/2000/svg",n)};t.graph_svg.prototype={element:function(){return this.e_svg},set_size:function(n,t){this.size.w=n;this.size.h=t;this.e_svg.setAttribute("width",n);this.e_svg.setAttribute("height",t)},clear:function(){for(var n=this.lines.length;n--;)this.e_svg.removeChild(this.lines[n]);this.lines.length=0},draw_line:function(n,i,r){var u=t.graph_svg.c("path");u.setAttribute("stroke",this.opts.line_color);u.setAttribute("stroke-width",this.opts.line_width);u.setAttribute("fill","transparent");this.lines.push(u);this.e_svg.appendChild(u);this._bezier_to(u,i.x+r.x,i.y+r.y,n.x+r.x,n.y+r.y)},copy_to:function(n,t){var i=new Image;i.onload=function(){n.drawImage(i,0,0);!t||t()};i.src="data:image/svg+xml;base64,"+btoa((new XMLSerializer).serializeToString(this.e_svg))},_bezier_to:function(n,t,i,r,u){n.setAttribute("d","M"+t+" "+i+" C "+(t+(r-t)*2/3)+" "+i+", "+t+" "+u+", "+r+" "+u)},_line_to:function(n,t,i,r,u){n.setAttribute("d","M "+t+" "+i+" L "+r+" "+u)}};t.view_provider=function(n,t){this.opts=t;this.jm=n;this.layout=n.layout;this.container=null;this.e_panel=null;this.e_nodes=null;this.size={w:0,h:0};this.selected_node=null;this.editing_node=null;this.graph=null};t.view_provider.prototype={init:function(){if(i.debug("view.init"),this.container=v(this.opts.container)?this.opts.container:a(this.opts.container),!this.container){i.error("the options.view.container was not be found in dom");return}this.e_panel=u("div");this.e_nodes=u("jmnodes");this.e_editor=u("input");this.graph=this.opts.engine.toLowerCase()==="svg"?new t.graph_svg(this):new t.graph_canvas(this);this.e_panel.className="jsmind-inner";this.e_panel.tabIndex=1;this.e_panel.appendChild(this.graph.element());this.e_panel.appendChild(this.e_nodes);this.e_editor.className="jsmind-editor";this.e_editor.type="text";this.actualZoom=1;this.zoomStep=.1;this.minZoom=.5;this.maxZoom=2;var n=this;t.util.dom.add_event(this.e_editor,"keydown",function(t){var i=t||event;i.keyCode==13&&(n.edit_node_end(),i.stopPropagation())});t.util.dom.add_event(this.e_editor,"blur",function(){n.edit_node_end()});this.container.appendChild(this.e_panel)},add_event:function(n,i,r){t.util.dom.add_event(this.e_nodes,i,function(t){var i=t||event;r.call(n,i)})},get_binded_nodeid:function(n){if(n==null)return null;var t=n.tagName.toLowerCase();return t=="jmnodes"||t=="body"||t=="html"?null:t=="jmnode"||t=="jmexpander"?n.getAttribute("nodeid"):this.get_binded_nodeid(n.parentElement)},is_expander:function(n){return n.tagName.toLowerCase()=="jmexpander"},reset:function(){i.debug("view.reset");this.selected_node=null;this.clear_lines();this.clear_nodes();this.reset_theme()},reset_theme:function(){var n=this.jm.options.theme;this.e_nodes.className=n?"theme-"+n:""},reset_custom_style:function(){var n=this.jm.mind.nodes;for(var t in n)this.reset_node_custom_style(n[t])},load:function(){i.debug("view.load");this.init_nodes()},expand_size:function(){var i=this.layout.get_min_size(),r=i.w+this.opts.hmargin*2,u=i.h+this.opts.vmargin*2,n=this.e_panel.clientWidth,t=this.e_panel.clientHeight;n<r&&(n=r);t<u&&(t=u);this.size.w=n;this.size.h=t},init_nodes_size:function(n){var t=n._data.view;t.width=t.element.clientWidth;t.height=t.element.clientHeight},init_nodes:function(){var n=this.jm.mind.nodes,i=r.createDocumentFragment();for(var t in n)this.create_node_element(n[t],i);this.e_nodes.appendChild(i);for(t in n)this.init_nodes_size(n[t])},add_node:function(n){this.create_node_element(n,this.e_nodes);this.init_nodes_size(n)},create_node_element:function(n,t){var f=null,i,r;"view"in n._data?f=n._data.view:(f={},n._data.view=f);i=u("jmnode");n.isroot?i.className="root":(r=u("jmexpander"),o(r,"-"),r.setAttribute("nodeid",n.id),r.style.visibility="hidden",t.appendChild(r),f.expander=r);!n.topic||(this.opts.support_html?c(i,n.topic):o(i,n.topic));i.setAttribute("nodeid",n.id);i.style.visibility="hidden";this._reset_node_custom_style(i,n.data);t.appendChild(i);f.element=i},remove_node:function(n){var t,i,r,u;for(this.selected_node!=null&&this.selected_node.id==n.id&&(this.selected_node=null),this.editing_node!=null&&this.editing_node.id==n.id&&(n._data.view.element.removeChild(this.e_editor),this.editing_node=null),t=n.children,i=t.length;i--;)this.remove_node(t[i]);n._data.view&&(r=n._data.view.element,u=n._data.view.expander,this.e_nodes.removeChild(r),this.e_nodes.removeChild(u),n._data.view.element=null,n._data.view.expander=null)},update_node:function(n){var i=n._data.view,t=i.element;!n.topic||(this.opts.support_html?c(t,n.topic):o(t,n.topic));i.width=t.clientWidth;i.height=t.clientHeight},select_node:function(n){!this.selected_node||(this.selected_node._data.view.element.className=this.selected_node._data.view.element.className.replace(/\s*selected\b/i,""),this.reset_node_custom_style(this.selected_node));!n||(this.selected_node=n,n._data.view.element.className+=" selected",this.clear_node_custom_style(n))},select_clear:function(){this.select_node(null)},get_editing_node:function(){return this.editing_node},is_editing:function(){return!!this.editing_node},edit_node_begin:function(n){if(!n.topic){i.warn("don't edit image nodes");return}this.editing_node!=null&&this.edit_node_end();this.editing_node=n;var u=n._data.view,t=u.element,f=n.topic,r=getComputedStyle(t);this.e_editor.value=f;this.e_editor.style.width=t.clientWidth-parseInt(r.getPropertyValue("padding-left"))-parseInt(r.getPropertyValue("padding-right"))+"px";t.innerHTML="";t.appendChild(this.e_editor);t.style.zIndex=5;this.e_editor.focus();this.e_editor.select()},edit_node_end:function(){var n;if(this.editing_node!=null){n=this.editing_node;this.editing_node=null;var u=n._data.view,i=u.element,r=this.e_editor.value;i.style.zIndex="auto";i.removeChild(this.e_editor);t.util.text.is_empty(r)||n.topic===r?this.opts.support_html?c(i,n.topic):o(i,n.topic):this.jm.update_node(n.id,r)}},get_view_offset:function(){var n=this.layout.bounds,t=(this.size.w-n.e-n.w)/2,i=this.size.h/2;return{x:t,y:i}},resize:function(){this.graph.set_size(1,1);this.e_nodes.style.width="1px";this.e_nodes.style.height="1px";this.expand_size();this._show()},_show:function(){this.graph.set_size(this.size.w,this.size.h);this.e_nodes.style.width=this.size.w+"px";this.e_nodes.style.height=this.size.h+"px";this.show_nodes();this.show_lines();this.jm.invoke_event_handle(t.event_type.resize,{data:[]})},zoomIn:function(){return this.setZoom(this.actualZoom+this.zoomStep)},zoomOut:function(){return this.setZoom(this.actualZoom-this.zoomStep)},setZoom:function(n){if(n<this.minZoom||n>this.maxZoom)return!1;this.actualZoom=n;for(var t=0;t<this.e_panel.children.length;t++)this.e_panel.children[t].style.transform="scale("+n+")";return this.show(!0),!0},_center_root:function(){var n=this.e_panel.clientWidth,t=this.e_panel.clientHeight,i;this.size.w>n&&(i=this.get_view_offset(),this.e_panel.scrollLeft=i.x-n/2);this.size.h>t&&(this.e_panel.scrollTop=(this.size.h-t)/2)},show:function(n){i.debug("view.show");this.expand_size();this._show();!n||this._center_root()},relayout:function(){this.expand_size();this._show()},save_location:function(n){var t=n._data.view;t._saved_location={x:parseInt(t.element.style.left)-this.e_panel.scrollLeft,y:parseInt(t.element.style.top)-this.e_panel.scrollTop}},restore_location:function(n){var t=n._data.view;this.e_panel.scrollLeft=parseInt(t.element.style.left)-t._saved_location.x;this.e_panel.scrollTop=parseInt(t.element.style.top)-t._saved_location.y},clear_nodes:function(){var i=this.jm.mind,t,n,r;if(i!=null){t=i.nodes;n=null;for(r in t)n=t[r],n._data.view.element=null,n._data.view.expander=null;this.e_nodes.innerHTML=""}},show_nodes:function(){var s=this.jm.mind.nodes,n=null,i=null,t=null,u=null,e=null,h="-",f=null,r=this.get_view_offset();for(var c in s){if(n=s[c],f=n._data.view,i=f.element,t=f.expander,!this.layout.is_visible(n)){i.style.display="none";t.style.display="none";continue}this.reset_node_custom_style(n);u=this.layout.get_node_point(n);f.abs_x=r.x+u.x;f.abs_y=r.y+u.y;i.style.left=r.x+u.x+"px";i.style.top=r.y+u.y+"px";i.style.display="";i.style.visibility="visible";!n.isroot&&n.children.length>0&&(h=n.expanded?"-":"+",e=this.layout.get_expander_point(n),t.style.left=r.x+e.x+"px",t.style.top=r.y+e.y+"px",t.style.display="",t.style.visibility="visible",o(t,h));n.isroot||n.children.length!=0||(t.style.display="none",t.style.visibility="hidden")}},reset_node_custom_style:function(n){this._reset_node_custom_style(n._data.view.element,n.data)},_reset_node_custom_style:function(n,t){var i,r;"background-color"in t&&(n.style.backgroundColor=t["background-color"]);"foreground-color"in t&&(n.style.color=t["foreground-color"]);"width"in t&&(n.style.width=t.width+"px");"height"in t&&(n.style.height=t.height+"px");"font-size"in t&&(n.style.fontSize=t["font-size"]+"px");"font-weight"in t&&(n.style.fontWeight=t["font-weight"]);"font-style"in t&&(n.style.fontStyle=t["font-style"]);"background-image"in t&&(i=t["background-image"],i.startsWith("data")&&t.width&&t.height?(r=new Image,r.onload=function(){var t=u("canvas"),i,r,f;t.width=n.clientWidth;t.height=n.clientHeight;i=this;t.getContext&&(r=t.getContext("2d"),r.drawImage(i,2,2,n.clientWidth,n.clientHeight),f=t.toDataURL(),n.style.backgroundImage="url("+f+")")},r.src=i):n.style.backgroundImage="url("+i+")",n.style.backgroundSize="99%","background-rotation"in t&&(n.style.transform="rotate("+t["background-rotation"]+"deg)"))},clear_node_custom_style:function(n){var t=n._data.view.element;t.style.backgroundColor="";t.style.color=""},clear_lines:function(){this.graph.clear()},show_lines:function(){var u;this.clear_lines();var t=this.jm.mind.nodes,n=null,i=null,r=null,f=this.get_view_offset();for(u in t)(n=t[u],n.isroot)||"visible"in n._data.layout&&!n._data.layout.visible||(i=this.layout.get_node_point_in(n),r=this.layout.get_node_point_out(n.parent),this.graph.draw_line(r,i,f))}};t.shortcut_provider=function(n,t){this.jm=n;this.opts=t;this.mapping=t.mapping;this.handles=t.handles;this._newid=null;this._mapping={}};t.shortcut_provider.prototype={init:function(){t.util.dom.add_event(this.jm.view.e_panel,"keydown",this.handler.bind(this));this.handles.addchild=this.handle_addchild;this.handles.addbrother=this.handle_addbrother;this.handles.editnode=this.handle_editnode;this.handles.delnode=this.handle_delnode;this.handles.toggle=this.handle_toggle;this.handles.up=this.handle_up;this.handles.down=this.handle_down;this.handles.left=this.handle_left;this.handles.right=this.handle_right;for(var n in this.mapping)!!this.mapping[n]&&n in this.handles&&(this._mapping[this.mapping[n]]=this.handles[n]);this._newid=typeof this.opts.id_generator=="function"?this.opts.id_generator:t.util.uuid.newid},enable_shortcut:function(){this.opts.enable=!0},disable_shortcut:function(){this.opts.enable=!1},handler:function(n){var t,i;if(n.which==9&&n.preventDefault(),!this.jm.view.is_editing()){if(t=n||event,!this.opts.enable)return!0;i=t.keyCode+(t.metaKey<<13)+(t.ctrlKey<<12)+(t.altKey<<11)+(t.shiftKey<<10);i in this._mapping&&this._mapping[i].call(this,this.jm,n)}},handle_addchild:function(n){var i=n.get_selected_node(),t,r;!i||(t=this._newid(),r=n.add_node(i,t,"New Node"),!r||(n.select_node(t),n.begin_edit(t)))},handle_addbrother:function(n){var i=n.get_selected_node(),t,r;!i||i.isroot||(t=this._newid(),r=n.insert_node_after(i,t,"New Node"),!r||(n.select_node(t),n.begin_edit(t)))},handle_editnode:function(n){var t=n.get_selected_node();!t||n.begin_edit(t)},handle_delnode:function(n){var t=n.get_selected_node();!t||t.isroot||(n.select_node(t.parent),n.remove_node(t))},handle_toggle:function(n,t){var i=t||event,r=n.get_selected_node();!r||(n.toggle_node(r.id),i.stopPropagation(),i.preventDefault())},handle_up:function(n,t){var f=t||event,u=n.get_selected_node(),i,r;!u||(i=n.find_node_before(u),i||(r=n.find_node_before(u.parent),!!r&&r.children.length>0&&(i=r.children[r.children.length-1])),!i||n.select_node(i),f.stopPropagation(),f.preventDefault())},handle_down:function(n,t){var f=t||event,u=n.get_selected_node(),i,r;!u||(i=n.find_node_after(u),i||(r=n.find_node_after(u.parent),!!r&&r.children.length>0&&(i=r.children[0])),!i||n.select_node(i),f.stopPropagation(),f.preventDefault())},handle_left:function(n,i){this._handle_direction(n,i,t.direction.left)},handle_right:function(n,i){this._handle_direction(n,i,t.direction.right)},_handle_direction:function(n,t,i){var h=t||event,u=n.get_selected_node(),f=null,o,e,r,s;if(!!u){if(u.isroot){for(o=u.children,r=[],e=0;e<o.length;e++)o[e].direction===i&&r.push(e);f=o[r[Math.floor((r.length-1)/2)]]}else u.direction===i?(r=u.children,s=r.length,s>0&&(f=r[Math.floor((s-1)/2)])):f=u.parent;!f||n.select_node(f);h.stopPropagation();h.preventDefault()}}};t.plugin=function(n,t){this.name=n;this.init=t};t.plugins=[];t.register_plugin=function(n){n instanceof t.plugin&&t.plugins.push(n)};t.init_plugins=function(i){n.setTimeout(function(){t._init_plugins(i)},0)};t._init_plugins=function(n){for(var u=t.plugins.length,i=null,r=0;r<u;r++)i=t.plugins[r].init,typeof i=="function"&&i(n)};t.show=function(n,i){var r=new t(n);return r.show(i),r};typeof module!="undefined"&&typeof exports=="object"?module.exports=t:typeof define=="function"&&(define.amd||define.cmd)?define(function(){return t}):n[f]=t})(typeof window!="undefined"?window:global),function(n){"use strict";var u=n.document,t=n["jsMind"],e;if(t&&typeof t.draggable=="undefined"){var r=t.util.dom,f="getSelection"in n?function(){n.getSelection().removeAllRanges()}:function(){u.selection.empty()},i={line_width:5,lookup_delay:500,lookup_interval:80};t.draggable=function(n){this.jm=n;this.e_canvas=null;this.canvas_ctx=null;this.shadow=null;this.shadow_w=0;this.shadow_h=0;this.active_node=null;this.target_node=null;this.target_direct=null;this.client_w=0;this.client_h=0;this.offset_x=0;this.offset_y=0;this.hlookup_delay=0;this.hlookup_timer=0;this.capture=!1;this.moved=!1};t.draggable.prototype={init:function(){this._create_canvas();this._create_shadow();this._event_bind()},resize:function(){this.jm.view.e_nodes.appendChild(this.shadow);this.e_canvas.width=this.jm.view.size.w;this.e_canvas.height=this.jm.view.size.h},_create_canvas:function(){var n=u.createElement("canvas"),t;this.jm.view.e_panel.appendChild(n);t=n.getContext("2d");this.e_canvas=n;this.canvas_ctx=t},_create_shadow:function(){var n=u.createElement("jmnode");n.style.visibility="hidden";n.style.zIndex="3";n.style.cursor="move";n.style.opacity="0.7";this.shadow=n},reset_shadow:function(n){var t=this.shadow.style;this.shadow.innerHTML=n.innerHTML;t.left=n.style.left;t.top=n.style.top;t.width=n.style.width;t.height=n.style.height;t.backgroundImage=n.style.backgroundImage;t.backgroundSize=n.style.backgroundSize;t.transform=n.style.transform;this.shadow_w=this.shadow.clientWidth;this.shadow_h=this.shadow.clientHeight},show_shadow:function(){this.moved||(this.shadow.style.visibility="visible")},hide_shadow:function(){this.shadow.style.visibility="hidden"},_magnet_shadow:function(n){!n||(this.canvas_ctx.lineWidth=i.line_width,this.canvas_ctx.strokeStyle="rgba(0,0,0,0.3)",this.canvas_ctx.lineCap="round",this._clear_lines(),this._canvas_lineto(n.sp.x,n.sp.y,n.np.x,n.np.y))},_clear_lines:function(){this.canvas_ctx.clearRect(0,0,this.jm.view.size.w,this.jm.view.size.h)},_canvas_lineto:function(n,t,i,r){this.canvas_ctx.beginPath();this.canvas_ctx.moveTo(n,t);this.canvas_ctx.lineTo(i,r);this.canvas_ctx.stroke()},_lookup_close_node:function(){var p=this.jm.get_root(),nt=p.get_location(),tt=p.get_size(),it=nt.x+tt.w/2,e=this.shadow_w,o=this.shadow_h,u=this.shadow.offsetLeft,s=this.shadow.offsetTop,r,n,c=u+e/2>=it?t.direction.right:t.direction.left,w=this.jm.mind.nodes,f=null,b=Number.MAX_VALUE,h=0,l=null,k=null,d=null,g,a,v,y;for(g in w)if(f=w[g],f.isroot||f.direction==c){if(f.id==this.active_node.id)continue;if(r=f.get_size(),n=f.get_location(),c==t.direction.right){if(u-n.x-r.w<=0)continue;h=Math.abs(u-n.x-r.w)+Math.abs(s+o/2-n.y-r.h/2);a={x:n.x+r.w-i.line_width,y:n.y+r.h/2};v={x:u+i.line_width,y:s+o/2}}else{if(n.x-u-e<=0)continue;h=Math.abs(u+e-n.x)+Math.abs(s+o/2-n.y-r.h/2);a={x:n.x+i.line_width,y:n.y+r.h/2};v={x:u+e-i.line_width,y:s+o/2}}h<b&&(l=f,k=a,d=v,b=h)}return y=null,!l||(y={node:l,direction:c,sp:d,np:k}),y},lookup_close_node:function(){var n=this._lookup_close_node();!n||(this._magnet_shadow(n),this.target_node=n.node,this.target_direct=n.direction)},_event_bind:function(){var n=this,t=this.jm.view.container;r.add_event(t,"mousedown",function(t){var i=t||event;n.dragstart.call(n,i)});r.add_event(t,"mousemove",function(t){var i=t||event;n.drag.call(n,i)});r.add_event(t,"mouseup",function(t){var i=t||event;n.dragend.call(n,i)});r.add_event(t,"touchstart",function(t){var i=t||event;n.dragstart.call(n,i)});r.add_event(t,"touchmove",function(t){var i=t||event;n.drag.call(n,i)});r.add_event(t,"touchend",function(t){var i=t||event;n.dragend.call(n,i)})},dragstart:function(t){var o,r,f,e,u;this.jm.get_editable()&&(this.capture||(this.active_node=null,o=this.jm.view,r=t.target||event.srcElement,r.tagName.toLowerCase()=="jmnode")&&(f=o.get_binded_nodeid(r),!f||(e=this.jm.get_node(f),e.isroot||(this.reset_shadow(r),this.active_node=e,this.offset_x=(t.clientX||t.touches[0].clientX)-r.offsetLeft,this.offset_y=(t.clientY||t.touches[0].clientY)-r.offsetTop,this.client_hw=Math.floor(r.clientWidth/2),this.client_hh=Math.floor(r.clientHeight/2),this.hlookup_delay!=0&&n.clearTimeout(this.hlookup_delay),this.hlookup_timer!=0&&n.clearInterval(this.hlookup_timer),u=this,this.hlookup_delay=n.setTimeout(function(){u.hlookup_delay=0;u.hlookup_timer=n.setInterval(function(){u.lookup_close_node.call(u)},i.lookup_interval)},i.lookup_delay),this.capture=!0))))},drag:function(n){if(this.jm.get_editable()&&this.capture){n.preventDefault();this.show_shadow();this.moved=!0;f();var t=(n.clientX||n.touches[0].clientX)-this.offset_x,i=(n.clientY||n.touches[0].clientY)-this.offset_y,r=t+this.client_hw,u=i+this.client_hh;this.shadow.style.left=t+"px";this.shadow.style.top=i+"px";f()}},dragend:function(){if(this.jm.get_editable()){if(this.capture){if(this.hlookup_delay!=0&&(n.clearTimeout(this.hlookup_delay),this.hlookup_delay=0,this._clear_lines()),this.hlookup_timer!=0&&(n.clearInterval(this.hlookup_timer),this.hlookup_timer=0,this._clear_lines()),this.moved){var t=this.active_node,i=this.target_node,r=this.target_direct;this.move_node(t,i,r)}this.hide_shadow()}this.moved=!1;this.capture=!1}},move_node:function(n,i,r){var l=this.shadow.offsetTop,f;if(!!i&&!!n&&!t.node.inherited(n,i)){for(var s=i.children,h=s.length,u=null,c=Number.MAX_VALUE,e=null,o="_last_";h--;)u=s[h],u.direction==r&&u.id!=n.id&&(f=u.get_location().y-l,f>0&&f<c&&(c=f,e=u,o="_first_"));!e||(o=e.id);this.jm.move_node(n.id,o,i.id,r)}this.active_node=null;this.target_node=null;this.target_direct=null},jm_event_handle:function(n){n===t.event_type.resize&&this.resize()}};e=new t.plugin("draggable",function(n){var i=new t.draggable(n);i.init();n.add_event_listener(function(n,t){i.jm_event_handle.call(i,n,t)})});t.register_plugin(e)}}(window);